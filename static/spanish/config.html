<!DOCTYPE html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" type="text/css" href="skeleton.css">
</head>
<body>
<span id="popup" class="popuptext"></span>
<div class="headerdiv">
	<span class="headerleft">
        <a onclick="pageUp()">&#11013;</a>
    </span>
	&nbsp;Configuration
	<span class="headerright" id="header_time"></span>
</div>
<script type="text/javascript" src="common.js"></script>


<div class="middlediv">Enter password</div>
When pressing save, you will be asked for the password of the microcontroller. You can leave the username blank.

<div class="middlediv2">Change configuration
password</div>
    <input id="password_required" name="password_required" type="checkbox"/>
    <label for="password_required">Password is required to make configuration changes</label>
    <br>
    <button type="button" onclick="save('password_required')">Save if password is required</button>
    <br>&nbsp;
    <br>
    
    Define the passworod used connect to the microcontroller acting as access point (AP), this is, you select the microcontroller's SSID which is currently <b><span id="copy_hostname4"></span></b> and will be prompted for this password. This same password is also used to allow changes to the configuration (only if "password required" is checked). 
	<br>
	<label for="ap_password">New password:</label>
	<input id="ap_password" name="ap_password" type="password"/ size="15" oninput="validateNewPasswords()">
	<br>
	<label for="repeat_ap_password">Type new password again to check:</label>
	<input id="repeat_ap_password" name="repeat_ap_password" type="password" size="15" oninput="validateNewPasswords()"/>
	<br>
	<button type="button" onclick="changePassword()" id="changePasswords"></button>
	<br>

	
<div class="middlediv">Network name and description</div>
	<label for="name">Host name, WiFi Access Point name and BLE name of this device (up to 15 characters A-Z, a-z, 0-9, start with a letter):</label>
	<input id="name" name="name" type="text" size="15" maxlength="15" oninput="hostnameChanged()"/>
	<br>
	
	<label for="description">Your description of this device  (free text). This description appears on some of the web pages, but serves no other function:</label>
	<input id="description" name="description" type="text" style="width:auto" size="50"/>
	<br>

	<button type="button" onclick="save('description','name')">Save description and host name</button>

<div class="middlediv">WiFi Router or hotspot (station mode)</div>
	The microcontroller will try to connect to the primary and then the secondary access point/router/hotspot until one of these responds. Once connected, you can reach the microcontroller from a PC or the cell phone entering <b>http://<span id="copy_hostname3"></span>.local</b> in your browser. This form of connection is the preferred way to connect to the microcontroller. Only WiFi 2.4Ghz, no 5Ghz.
	<br>
	<label for="access_point1" >SSID of primary router/hotspot the microcontroller should connect to (Example: a hotspot/access point on your cell phone):</label>
	<input id="access_point1" name="access_point1" type="text"/>
	<br>
	<label for="password1">Password of the primary router/hotspot:</label>
	<input id="password1" name="password1" type="password" size="16"/>
	<br>
	<label for="access_point2" >SSID of secondary router/hotspot the microcontroller should connect to, if the primary is not available (Example: your home router):</label>
	<input id="access_point2" name="access_point2" type="text"/>
	<br>
	<label for="password2">Password of the secondary router/hotspot:</label>
	<input id="password2" name="password2" type="password" size="16"/>
	<br>
	<button type="button" onclick="save('access_point1','password1','access_point2','password2')">Save WiFi info and passwords</button>

<div class="middlediv">Change pins and MIDI assignment</div>
	<button type="button" onclick="window.location.href='pinout.html'">Go to pinout page</button>
    
<div class="middlediv">Power management</div>
	<label for="battery_watt_hours">Watt-hours (Wh) capacity of the battery. Wh = mAh * Volts / 1000. For example: Ten 2000mAh NiMH AA batteries at 1.2V = 2000*1.2*10/1000 = 24 Wh. For example: three 3000 mAh Lithium batteries at 3.3V = 3000*3.3*3/1000=30 Wh. Decimal point allowed:</label>
	<input id="battery_watt_hours" name="battery_watt_hours" type="text" size="4"/>
	<br>
    
	<label for="solenoid_watts">Solenoid power consumption in Watts. For example for solenoids at 12V with a resistance of 90 Ohms, power=12V*12V/90Ohms  = 1.6 Watts. Decimal point allowed</label>
	<input id="solenoid_watts" name="solenoid_watts" type="text" size="4"/>&nbsp;W.
	<br>
    
    <label for="fixed_watts">Fixed power consumption of microcontroller and power converter, in Watts. For example: the microcontroller comsumes 60mA average at 5V = 0.060A*5V = 0.3W. Decimal point allowed:</label>
	<input id="fixed_watts" name="fixed_watts" type="text" size="4"/>&nbsp;W.
	<br>

	
	<label for="idle_deepsleep_minutes">After this time the microcontroller will enter deepsleep if idle, for example: not playing music, no web activity, no FTP. Turn power off then on to restore function.  No decimals, integer only:</label>
	<input id="idle_deepsleep_minutes" name="idle_deepsleep_minutes" type="text" size="3"/>&nbsp;minutes.
	<br>

	
	<label for="ap_max_idle">Time the AP WiFi radio will be active  without no one connecting. After this time, if idle, the WiFi radio of the AP will be turned off save energy. However, if no station mode connection is active, the AP mode is left active to have a fallback connection available and the station mode is disabled. This makes AP mode the fallback mode, i.e. the last resort mode to connect to the microcontroller, should other WiFi modes fail.  No decimals, integer only:</label>
	<input id="ap_max_idle" name="ap_max_idle" type="text" size="4"/>
	<br>
	<button type="button" onclick="save('battery_watt_hours','idle_deepsleep_minutes','ap_max_idle', 'solenoid_watts' )">Save power settings</button>


<div class="middlediv">Enable FTP access</div>
	With this option you can use Windows Explorer or FileZilla to access all files in the microcontroller with the FTP standard (File Transfer Protocol). This enables to copy or replace files with drag and drop operations. One good use is to prepare a new tunelib on the PC and copy all midifiles and tunelib.json to the microcontroller just with dreag and drop. The FTP server will stop with the next power down.
	<br>
	<button type="button" onclick="startFTP()">Start FTP on the microcontroller</button>

<div class="middlediv">Other parameters</div>
    Time zone identifier, such as Europe/Berlin, or America/Lima. See <a href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones">List of tz database time zones</a> for a list of valid TZ identifiers.
	<input id="tzidentifier" name="tzidentifier" type="text" size="20"/>
    <br>
	The WiFi SSID of this microcontroller as Access Point is: <b><span id="copy_hostname1"></span></b>. IP address when connecting to the access point of the microcontroller. Should not be necessary to change. Could be used as address with the broser, for example: http://192.168.144.1
	<label for="ap_ip">IP as access point. Should be of type 192.168.xxx.yyy with xxx and yyy between 1 and 255:</label>
	<input id="ap_ip" name="ap_ip" type="text"/>
	<br>
    
    <label for="touchpad_big_change">Touchpad responsiveness (higher=less responsive, lower=more responsive). Start with 10000.  No decimals, integer only:</label>
	<input id="touchpad_big_change" name="touchpad_big_change" type="text" size="6"/>
	<br>&nbsp;
    <br>
    
    <label for="initial_page">Initial page (home page):</label>
    <br>
    <input type="radio" name="initial_page" id="index" value="index"/>Main menu page
    <br>
    <input type="radio" name="initial_page" id="tunelist" value="tunelist"/>Tune list page
    <br>
    <input type="radio" name="initial_page" id="play" value="play"/>Performance page
	<br>
	
	<button type="button" onclick="save( 'ap_ip', 'tzidentifier', 'touchpad_big_change', 'initial_page' )">Save other parameters</button>
    
<div class="middlediv2">Debug/test settings</div>
   
	<input id="webserver_cache" name="webserver_cache" type="checkbox"/>
	<label for="webserver_cache">Cache pages in browser. Uncheck only for debugging as not caching pages is slow and slows down the microcontroller unnecessarily:</label>
	
	<br>
	<label for="max_age">Maximum age in cache, in seconds. 0=no caching. A value of 7200 (2 hours) is appropriate.  No decimals, integer only:</label>	<input id="max_age" name="max_age" type="text" size="6"/>



    <br>
    <input type="checkbox" name="microphone" id="mic_test_mode" value="mic_test_mode">
    <label for="mic_test_mode">Debug mode for microphone. Generates random signals to test tuning mode. If a microphone is present, it is ignored:</label>
    
    <br>
	<button type="button" onclick="save( 'webserver_cache', 'max_age',  'mic_test_mode' )">Save debug settings</button>

		
<div class="footerdiv"></div>
<script>

function hostnameChanged(){
	let hostname = document.getElementById("name").value ;
	textById("copy_hostname1", hostname ) ;
	textById("copy_hostname3", hostname ) ;
	textById("copy_hostname4", hostname ) ;
}
	
async function getCurrentConfig(){
	let json_result = await fetch_json( "/get_config" ) ;
	for( let [key, value] of Object.entries(json_result)) {
        if( key  == "initial_page" ) {
            // this is a radiobutton, "initial_page" is the name of the
            // group. the ids are "index", "tunelist", "performance"
            key = value ;
            
            value = true ;
        }
        d = document.getElementById( key );
        if( d != null ){
            if( d.type == "checkbox" || d.type == "radio" ) {
                d.checked = value ;
            }
            else {
                d.value = value ;
            }
        }
	}
	hostnameChanged() ;
}
getCurrentConfig() ;
	
function validateNewPasswords(){
    // Check if passwords are equal and minimum length
    // necessary for WiFi.
	p1 = document.getElementById("ap_password").value ;
	p2 = document.getElementById("repeat_ap_password").value ;
	ok = false ;
	button = document.getElementById("changePasswords") ;
    // For better response check password length here
	if( p1 != p2 ){
		button.innerText = "(passwords are different, cannot save!)" ;
		button.disabled = true ;
		ok = false ;
	}
	else if( p1.length < 9 ){
		button.innerText = "(password shorter than 9 characters, cannot save!)" ;
		button.disabled = true ;
		ok = false ;
	}
	else {
		button.innerText = "Save password"
		button.disabled = false ;
		ok = true ;
	}
	return ok ;
}
validateNewPasswords() ;


async function changePassword() {
	if( validateNewPasswords() ){
		save( "ap_password" ) ;
	}
}
	
async function save( /* argument list */) {
    // Save new configuration data
	let post_data = {} ;
    // Always add password entered, changing config
    // only allowed with password.

    // Add al arguments of save to list
    let value = "" ;
	for( var i=0; i<arguments.length; i++){
        // no need to escapeHtml description
        if( arguments[i] == "initial_page" ){
            value = getRadioButtonValue( arguments[i] );
        }
        else if( arguments[i] == "description" ){
            value = removeSpecialHtml( getValue( arguments[i] ));
        }
        else{
            value = getValue( arguments[i] )
        }

        post_data[ arguments[i] ] = value ;
	}	
	const resp = await fetch_json( "/save_config", post_data ) ;
	if( resp["result"] == "ok") {
		showPopup( "", "Configuration saved to flash" ) ;
	}
    await revoke_credentials();
}
function getValue( element_id ){
	let a = document.getElementById( element_id ) ;
    let value = null ;
	if( a.type == "checkbox") {
        value = a.checked ;
	}
	else {
		value = a.value.trim() ;
	}
	return value ;
}	

function getRadioButtonValue( element_name ) {
	// radio button:
	let checked = "" ;
	let values = document.getElementsByName( element_name );
	for( let radio of values ){
		if( radio.checked ){
			checked = radio.value ;
		}
	}
	return checked ;
}
	

async function startFTP(){
	await fetch_json("/start_ftp" ) ;
    await revoke_credentials();
}
function pageUp(){
	window.location.href = "/static/index.html" ;
}
    
</script>
</body>