<!DOCTYPE html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" type="text/css" href="/static/skeleton.css">
<!--
	<style>
	  th {
		background-color: #438029; 
		}
	</style>
-->
</head>

<body>
<span id="popup" class="popuptext"></span>
<div class="headerdiv">
	<span class="headerleft">
        <a onclick="pageUp()">&#11013;</a>
		&nbsp;Lista de melodías
    </span>
	<span class="headerright" id="header_time"></span>
</div>

<!-- html continues below javascript -->
<script type="text/javascript" src="/static/common.js"></script>
<script>
// Function to translate characters with accent and tilde
var   from = "ÃÀÁÄÂÈÉËÊÌÍÏÎÒÓÖÔÙÚÜÛãàáäâèéëêìíïîòóöôùúüûÑñÇç", 
      to   = "AAAAAEEEEIIIIOOOOUUUUaaaaaeeeeiiiioooouuuunncc",
      mapping = {};
 
for(var i = 0, j = from.length; i < j; i++ )
      mapping[ from.charAt( i ) ] = to.charAt( i );
 
function normalizaTildes( str ) {
      var ret = [];
      for( var i = 0, j = str.length; i < j; i++ ) {
          var c = str.charAt( i );
          if( mapping.hasOwnProperty( str.charAt( i ) ) )
              ret.push( mapping[ c ] );
          else
              ret.push( c );
      }      
      return ret.join( '' );
 }
  
function searchTable() {
	// Declare variables
	var input, filter, table, tr, td, i, txtValue;
	input = document.getElementById("searchInput");
	filter = input.value.toUpperCase();
	table = document.getElementById("tunelist");
	tr = table.getElementsByTagName("tr");

	// Loop through all table rows, and hide those who don't match the search query
	for (i = 1; i < tr.length; i++) {
		txtValue = normalizaTildes( tr[i].innerText ) ;
		if (txtValue.toUpperCase().indexOf(filter) > -1 ) {
				//|| txtValue.indexOf("Título") == 0 ) {
			tr[i].style.display = "";
		} else {
			tr[i].style.display = "none";
		}
	}
}
</script>
<!-- Search button, placeholder includes magnifying glass -->

	<input type="text" id="searchInput" onkeyup="searchTable()" 
		placeholder="&#128269;B&uacute;squeda">
	<button id="navigateToPlayPage" type="button" onclick="navigateToPlayPage()">Actuación</button>
	<div class="buttondiv"></div>
		<table id="tunelist">
		</table>
	<div class="footerdiv"></div>
</body>

<script>
// tunelib/tunelib.json is cached in tunelib
var tunelib = []; 

async function setTuneList( ) {
	// tunelib is global, don't use let
	tunelib = await fetch_json( "/tunelib_json" ) ;

	let hdr = tunelib.header ;
	verify_tunelib_header( hdr ) ;
	let header = ["T&iacute;tulo", "G&eacute;nero", "Autor", "", "A&ntilde;o"] ;
	let s = "<thead><tr>" ;
	for (let  j = 0 ; j < header.length ; j++ ){
		s += `<th class='tunetable'>${header[j]}</th>` ;
	}
	s += "</tr></thead>" ;
	s += "<tbody>" ;
	for( const [key, tune] of Object.entries(tunelib)) {
		if( key.substring(0,1) != "i" ){
			continue ;
		}
		h = `<tr> 
			 <td>
				<a onclick='queueTune("${tune[TLCOL_ID]}")'
					style='cursor:pointer'
					id='t${tune[TLCOL_ID]}'
				>${tune[TLCOL_TITLE]}</a>
			  </td>
			  <td>${tune[TLCOL_GENRE]}</td>
			  <td>${tune[TLCOL_AUTHOR]}</td>
		      <td>${formatMilliMMSS( tune[TLCOL_TIME] )}</td>
		      <td>${tune[TLCOL_YEAR]}</td>
		      </tr>`;
        s += h;
	}
	s += "</tbody>" ;
	htmlById("tunelist", s) ;
	
	await getProgress() ;
}

function navigateToPlayPage() {
	window.location.href = "/static/play.html" ;
}

async function queueTune( tune_number ) {
	showPopup( "t"+tune_number, "actualizando setlist");
	let progress = await fetch_json( "/queue_tune/" + tune_number ) ;
	updateProgress( progress ) ;
}

async function getProgress() {
	// Tunelib is global
	if( tunelib.length == 0 ){
		tunelib = await fetch_json( "/tunelib_json" ) ;
	}
	verify_tunelib_header( tunelib.header ) ;
	
	// Now that we have the tunelib, show progress
	while( true ) {
        let progress = await fetch_json ( "/get_progress" ) ;
        updateProgress( progress );
        if( progress["status"] == "playing"){
		  await sleep_ms( 10000 ) ;
        }
        else{
            await sleep_ms( 1000 ) ;
        }
	}
}

function updateProgress( progress ) {
	let black_bar = "&#9608;" ;
	let gray_bar = "&#9617;" ; 
	music_note = "&#127925;" ; 
	let queue_img = "&#127775;"; // Glowing Star
	let s = document.getElementById("tunelist").innerHTML ;
	// All marks (playing, queued) are enclosed in <span> ... </span>
	// Remove all marks:
	s = s.replace("<b>", "" )
	s = s.replace("</b>", "" )
	s = s.replace("<br>", "" )
	s = s.replace(/<span.*?<\/span>/gm, "" ) ;
	
	// Get progress
	let tune_number = progress["tune"] ;
	if ( tune_number === null ) {
		htmlById("tunelist", s) ;
		return ; // no tune playing...
	}

	let tune = tunelib["i" + tune_number] ;
	let t = tune[TLCOL_TIME] ;
	if( t > 0 ){
		percent = progress["playtime"]/tune[TLCOL_TIME]*100 ;
	}
	else {
		percent = 100 ;
	}
	
	let status_text = make_status_text( progress["status"], percent ) ;
	let title = tune[TLCOL_TITLE];
	let bold_title = "<b>" + title + "</b>" ;

	let bar_length = 10 ;
	let blacks = Math.round( bar_length * percent/100 ) ;
	let grays = bar_length - blacks ;
	let bar = "<br><span>" + music_note + status_text + " " + 
		black_bar.repeat( blacks ) + gray_bar.repeat( grays ) +
		"</span>";
	
	s = s.replace(">" + title + "<", ">" + bold_title + bar + "<" );
	
	let setlist = progress["setlist"] ;
	for( let i = 0; i < setlist.length; i++ ) {
		queued_tune = setlist[i] ;
		let title = tunelib["i" + queued_tune][TLCOL_TITLE] ;
		s = s.replace( ">" + title, "><span>" + queue_img +"(" + (i+1) + ") </span>" + title ) ;
	}
	htmlById("tunelist", s) ;

}

function pageUp() {
	// On index page, reload this same page
	window.location.href = "/static/index.html" ;
}


// setTuneList will call getProgress the first time, 
// and getProgress will continue refreshing...
setTuneList() ;
</script>