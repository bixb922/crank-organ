<!DOCTYPE html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" type="text/css" href="/static/skeleton.css">
	<style>
	  th {
		background-color: #D4AF37; 
		}
	</style>
</head>
<body>
<span id="popup" class="popuptext"></span>    
<div class="headerdiv">
	<span class="headerleft">
        <a onclick="pageUp()">&#11013;</a>
    </span>
	<span class="headerright" id="header_time"></span>
</div>

<script type="text/javascript" src="/static/common.js"></script>
<button type="button" onclick="tuneAll()" id="tuneAllButton">Tune all</button>

<button type="button" onclick="scaleTest()" id="scaleTestButton">Play scale</button>
    
<button type="button" onclick="clearTuning()" id="clearTuningButton">Clear stored tuning</button>

<button type="button" onclick="stopTuning()" id="stopTuningButton">Stop</button>

<div class="tableFixHead">
    <table id="notelist" style="width:100%">
    </table>
</div>
<div class="footerdiv"></div>

</body>

<script>

async function getNoteList() {
	while( true ) {
		updateNoteList( await fetch_json("/data/organtuner.json" ) );
		await sleep_ms( 5_000 ) ;
	}
}

function updateNoteList( notelist ) {
	const header = ["Program-note", "cents", "dB", 
		"Tuning (-"+max_cents+" a +"+max_cents+" cents)", 
		"Amplitude (" + min_db + " a " + max_db + " dB)",
        "Pin"] ;
	let s = "<thead><tr>" ;
	for (let i = 0; i < header.length; i++) {
		s += `<th>${header[i]}</th>`;
	}
	s += "</tr></thead>" ;
	s += "<tbody>" ;
    // notelist is a dictionary, key=midi note number
    
    let max_amplitude = get_max_amplitude( notelist ) ;
	for( let midi in notelist ){
		let note = notelist[midi]  ;
        let amp = list_average( note["amplist"] ) ;
        let ampdb = "-" ;
        if( amp != null ){
            let ampdb = amplitude_to_db( amp, max_amplitude ) ;
        }
        let cents = list_average( note["centslist"] ) ;
        if( cents == null ){
            cents = "-" ;
        }
        else {
            cents = Math.round( cents ) ;
        }
		s += `
		    <tr>
			 <td><a href="/note/${midi}">${note["name"]}</td>
			 <td>${cents}</td>
			 <td>${ampdb}</td>
			 <td id="tuning${midi}"></td>
			 <td id="amp${midi}"></td>
			 <td id="pin${midi}">${note["pinname"]}</td>
			</tr>`;
	};
	s += "</tbody>" ;
	htmlById("notelist", s) ;

	for( let midi in notelist ){
		let note = notelist[midi] ;
        let cents = list_average( note["centslist"] ) ;
        let elename = "tuning" + midi ;
        let docele = document.getElementById( elename ) ;
        if( cents != null ){
          docele.style.visibility = "visible" ;
		  lrBarGraph( elename, scale_cents( cents ), oxford_blue, scale_divisions_cents, 20 ) ;
        }
        else {
            docele.style.visibility = "hidden" ;
        }

        amp = list_average( note["amplist"] ) ;
        elename = "amp" + midi ;
        docele = document.getElementById( elename ) ;
        if( amp != null && amp > 0 ){
          docele.style.visibility = "visible" ;
		  let db = amplitude_to_db( amp, max_amplitude ) ;
		  barGraph( elename, scale_db( db ), sap_green, scale_divisions_db, "right", 20 );
        }
        else {
            docele.style.visibility = "hidden" ;
        }
    }	
}

async function tuneAll() {
	let textoOriginal = document.getElementById("tuneAllButton").innerText ;
	textById("tuneAllButton", "\u231B") ;
	updateNoteList( await fetch_json( "/tune_all" )  );
	textById("tuneAllButton", textoOriginal ) ;

}
    
async function clearTuning() {
    updateNoteList( await fetch_json( "/clear_tuning") ) ;
}
    
async function stopTuning() {
    await fetch_json( "/stop_tuning" ) ;
}


async function scaleTest() {
    await fetch_json( "/scale_test" ) ;   
}
    
function pageUp() {
	// Go back to index page
	window.location.href = "/static/index.html" ;
}

getNoteList() ;

</script>