<!DOCTYPE html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title id="pagetitle"></title>
	<link rel="stylesheet" type="text/css" href="/static/skeleton.css">
</head>

<body>
<span id="popup" class="popuptext"></span>
<div class="headerdiv">
	<span class="headerleft">
        <a onclick="pageUp()">&#11013;</a>
		&nbsp;<span>Historia</span>
    </span>
	<span class="headerright" id="header_time"></span>
</div>

<script type="text/javascript" src="/static/common.js"></script>
<script type="text/javascript" src="/static/translations.js"></script>

<div class="tableFixHead">

    <table>
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Melodía</th>
            <th>Avance %</th>
            <th><span>Pedido</span>&nbsp;</th>
          </tr>
        </thead>
        <tbody id="history">
        </tbody>
    </table>
</div>
<div class="middlediv"></div>
	Si historia más antigua que
	<input type="text" size="3" value="90" id="days"/>días,
	<button onclick="deleteHistory()" id="purgeButton">Borrar </button>
<div class="footerdiv"></div>
</body>

<script>

function compare( a, b ){
    // compare to sort in descending date order
    // dates are in yyyy-mm-dd hh:mm format
    datea = a[1];
    dateb = b[1];
    if( datea < dateb ){
        return 1 ;
    }
    if( datea > dateb ){
        return -1;
    }
    return 0;
}


async function getHistory( ) {
	let histlist = await fetch_json( "/data/history.json" ) ;
    histlist.sort( compareFn=compare ) ;
	let s = "" ;
    let previous_date = "";
	for( i in histlist ) {
        let hist_element = histlist[i]; 
        // 0 tuneid
        // 1 date in seconds since 2000/1/1 (ESP32 epoch)
        // 2 percentage
        // 3 requested by user (true/false)

        // Convert date from seconds in ESP32 epoch to string
        // date: yyyy-mm-dd, time: hh:mm
        let d = new Date(946_684_800_000); // ESP32 epoch start
        d.setUTCSeconds( hist_element[1] );
        let datetime = d.toISOString() ; // e.g. 2024-05-13T08:40:49.000Z
        let tsplit = datetime.split("T");
        let date = tsplit[0] ;
        let time = tsplit[1].substring(0,5) ;

        // Insert separator row with date when date changes
        if( date != previous_date) {
            s += `<tr>
            <td colspan="3"><b>${date}</b></td>
            <tr>` ;
        };
        previous_date = date ;

        // Mark if tune has been requested via web site
        let user_request = "" ;
        if( hist_element[3] ) {
            // user request
            user_request = "&#x2714;" ; // check mark
        }
        // Get title (if still in tunelib...)
        let tt = await make_tune_title( hist_element[0] );
		s += `<tr> 
			   <td>${time}</td>
			   <td>${tt}</td>
		       <td align="right">${hist_element[2]}%</td>
			   <td>${user_request}</td>
		      </tr>`;
	}
	htmlById("history", s) ;
}

async function deleteHistory(){
    // Purge old elements from history
	days = parseInt( document.getElementById("days").value );
	resp = await fetch_json( "/delete_history/" + days ) ;
    if( resp["result"] == "ok"){

       showPopup("", "Historia truncada" ); //>>>add to translation
       await sleep_ms(1000);
       window.location.reload() ;
    }
}

async function make_tune_title( tuneid ){
	let tunelib = await get_tunelib();
	let tune = tunelib[tuneid];
	if( tune != undefined ){
		let title = tune[TLCOL_TITLE] ;
        let text = title ;
		let info = tune[TLCOL_INFO] ;
		if( info != "" ){
			text += " (" + info  + ")";
		}
		info = get_rating(tune) ;
		if( info != "" ){
			text += " " + info ;
		}
        // append link to "add comment/rating"
        text += `&nbsp;<a onclick='register_comment( "${title}", "${tuneid}" )'>&#x1F4DD;</a>`;
        return text;
	}
    // Sorry if tune is not in tunelib anymore...
    return `(melodía borrada de tunelib) ${tuneid}` ;
}


async function register_comment(title, tuneid){
	comment = prompt(tlt("Ingrese comentario o puntaje *, ***,*** para: ") + title);
	if( comment != null ){
		j = { "tuneid": tuneid, "comment": comment };
		await fetch_json( "/register_comment", j );
		drop_tunelib() ;
        showPopup("", "Información actualizada"); //>>> add to translaation
        await sleep_ms(1000);
        window.location.reload() ;
    }
}

translate_html() ;
getHistory() ;
</script>