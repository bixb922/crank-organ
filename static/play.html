
<!DOCTYPE html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<title id="pagetitle"></title>
	<link rel="stylesheet" type="text/css" href="/static/skeleton.css">
</head>
<body>
<span id="popup" class="popuptext"></span>
<div class="headerdiv">
	<span class="headerleft">
        <a onclick="pageUp()">&#11013;</a>
	</span>
    &nbsp;&nbsp;&nbsp;<b>Melodía actual</b>
	<span class="headerright" id="header_time"></span>
</div>


<script type="text/javascript" src="/static/common.js"></script>
<script type="text/javascript" src="/static/translations.js"></script>

<h1 id="play_mode" style="display:none">Deshabilitado por afinador, pinout</h1>
<table id="main_info_table">
	<tbody>
		<tr id="request_row" style="display:none"><td>Pedido por</td><td id="spectator_name""></td></tr>
		<tr><td colspan="2" id="title"></td></td></tr>
		<tr id='controlButtons'><td colspan='2'> 
			<button onclick = 'startTune()'>Partir</button>
			<button onclick = 'backSetList()'>Al comienzo</button>
			<button onclick = 'stopTuneSetList()'>Próximo</button></td>
		</tr>
		<tr id="genre_row"><td>Género</td><td id="genre"></td></tr>
		<tr id="author_row"><td>Autor</td><td id="author"></td></tr>
		<tr id="duration_row"><td>Duración</td><td id="duration"></td></tr>
		<tr id="year_row"><td>Año</td><td id="year"></td></tr>
		<tr id="info_row"><td>Info</td><td id="info"></td></tr>
		<tr id="rating_row"><td>Puntos</td><td id="rating"></td></tr>
		<tr id="timebar_row"><td id="progress"></td><td id="timebar"></td></tr>
	</tbody>
</table>
<span id="no_tune_span">No hay melodía en curso</span>
<button id="toggleSetlistLyricsButton" onclick="toggleSetlistLyrics()">Mostrar letra</button>
<span id="setlist_span">
	<div class="middlediv">Setlist</div>

	<table>
		<tbody id="setlist">
		</tbody>
	</table>
	<button type="button" onclick="saveSetList()">Guardar setlist</button><span id="saved"></span>
	<button type="button" onclick="loadSetList()">Cargar setlist</button>
	<button type="button" onclick="clearSetList()">Borrar setlist</button>
	<button type="button" onclick="shuffleSetList()">Desordenar setlist</button>
	<button type="button" onclick="shuffleAllTunes()">Desordenar todos</button>
	<button type="button" onclick="go_history()">Historia</button>
</span>
<span id="lyrics_span" style="display:none">
	<div class="middlediv"><span>Letra</span>&nbsp;<a onclick="setColumns(1)" id="col1_link">1️⃣</a>&nbsp;<a onclick="setColumns(2)" id="col2_link">2️⃣</a></div>
	<table>
		<tbody>
			<tr><td id="col1"></td><td id="col2"></td></tr>
		</tbody>
	</table>
</span>
<span id="crank_span">
	<div class="middlediv">Control tempo</div>
		<span>Ajuste velocidad:</span>
		<br>
		<a onclick="set_velocity(-5)" style="cursor:pointer">&#9194;&nbsp;</a>
		<span id="velocityText"></span><span id="velocityGraph"></span>
		<a onclick="set_velocity(5)" style="cursor:pointer">&nbsp;&#9193;</a>
		<br>
		<span id="crankInfo">
			<br>
			<input type="checkbox" id="tempo_follows_crank" oninput="tempo_follows_crank()">Tempo sigue manivela</button>
			<br>
			<br>
			<span id="turning">Girando</span>
			<span id="rpsecText">nnn</span>&nbsp;rev/seg&nbsp;
			<span id="rpsecGraph"></span>
		</span>
</span>	

<div style="width:100%; height:5px"></div>
<div class="footerdiv"></div>

</body>

<script>

// Tune list with titles and attributes gets loaded in memory
let last_progress_seen = {} ;
let columns = 1;
let current_tuneid = "" ;
async function getProgress() {	
	sleep_ms(1) ;
	while( true ) {
        progress = await fetch_json ( "/get_progress" ) ;
        if( progress == undefined ){
            showPopup( "", tlt("No hay información de avance disponible"));
        }

        await updateProgress( progress );
		await sleep_ms( 2_000 ) ;
	}
}

async function updateProgress( progress ) {
    if( progress == undefined ){
        return ;
    }
	console.log("updateProgress", progress );
    // Get tunelib with local cache
    let tunelib = await get_tunelib() ;
	last_progress_seen = progress ;

    let pm = "none";
    if( progress["play_mode"] == false ){
        pm = "" ;
    }
    document.getElementById("play_mode").style.display = pm ;
	// Update tune info only if tune is playing
	current_tuneid = progress["tune"] ;
    let tune_requests = progress["tune_requests"] ;
    if( tune_requests == undefined ){
        tune_requests = {} ;
    }
	let toggle_button = document.getElementById("toggleSetlistLyricsButton") ;
    let s = "" ;
	if( current_tuneid === null ) {
		// No tune playing
		showHideElement( "main_info_table", false );
		showHideElement( "no_tune_span", true ) ;
        
		textById("progress", "...") ;
		progressBar( "timebar", 0, 60 ) ;
		toggle_button.style.display = "none" ;
		let col1 = document.getElementById( "col1") ;
    	col1.innerText ="" ;
		// Make sure to show setlist controls if no tune
		toggleSetlistLyrics( "setlist" ) ;
	}
	else {
		let tune = tunelib[current_tuneid] ;
		showHideElement( "main_info_table", true );
		showHideElement( "no_tune_span", false ) ;

        let spectator_name = tune_requests[current_tuneid];
		textById( "spectator_name",  spectator_name );
		showHideElement( "request_row", spectator_name );

		textById( "title", tune[TLCOL_TITLE]) ;

		textById( "genre", tune[TLCOL_GENRE]) ;
		showHideElement( "genre_row", tune[TLCOL_GENRE]) ;

		textById( "author", tune[TLCOL_AUTHOR] ) ;
		showHideElement( "author_row", tune[TLCOL_AUTHOR ] );

		textById( "duration",formatMilliMMSS( tune[TLCOL_TIME] ));

		textById( "year", tune[TLCOL_YEAR]) ;
		showHideElement( "year_row", tune[TLCOL_YEAR]) ;

		textById( "info", tune[TLCOL_INFO]) ;
		showHideElement( "info_row", tune[TLCOL_INFO]) ;

		let rating = get_rating(tune);
		htmlById( "rating", rating) ;
		showHideElement( "rating_row", rating ) ;

		let lyrics = await formatLyrics() ;
		if( lyrics == "" ){
			// No lyrics, no toggle button and setlist controls only
			// If lyrics were showing, switch to setlist
			toggleSetlistLyrics( "setlist" );
			toggle_button.style.display = "none";
		}
		else{
			// There are lyrics: show button to toggle setlist/lyrics
			toggle_button.style.display = "" ;
		}
		
		// Update progress bar every second, first call
		let percent = progress["playtime"]/tune[TLCOL_TIME]*100 ; // Time
		status_text = make_status_text( progress["status"], percent ) ;
		textById("progress", status_text) ;
		
		progressBar( "timebar", percent, 60 );
	}
	let setlist = progress["setlist"] ;
	s = "";
	for( let i = 0; i < setlist.length; i++ ) {
        let tuneid = setlist[i];
		let pls = tunelib[tuneid] ;
        if( pls == undefined ){
            continue ;
        }
		s += "<tr>" ;
		s += "<td>" + (i+1) + "</td>" ;
		s += "<td>" + pls[TLCOL_TITLE] + "</td>" ;
		// emojis are up-arrow, down-arrow, "top" and wastebasket
		let b1 = "<td><a onclick='upSetList  ("+i+")' style='cursor:pointer'>&#128316;</a></td>"; // Up arrow
		let b2 = "<td><a onclick='downSetList ("+i+")' style='cursor:pointer'>&#128317;</a></td>" ; // Down arrow
		let b3 = "<td><a onclick='topSetList("+i+")' style='cursor:pointer'>&#128285;</a></td>" ; // Arrow Top
		let b4 = "<td><a onclick='dropSetList("+i+")' style='cursor:pointer'>&#128465;</a></td>" ; // Thrash can
		if( i == 0 ) {
			// First line does not have "top" nor "up" icons
			b1 = "<td></td>";
			b3 = "<td></td>";
		}
		else if( i == setlist.length-1 ) {
			// last line does not have "down" icon
			b2 = "<td></td>" ;
		}
		s += b1 + b2 + b3 + b4;
        

        // show spectator name, if any
        let sn = tune_requests[tuneid] ;
        if( sn != undefined ){
            s += `<td>${sn}</td>`;
        }
		s += "</tr>" ;

	}
	htmlById("setlist", s ) ;

	// Always update velocity and RPS
	let vel = progress["velocity"];
	velocityBar( "velocityGraph", vel, 60 ) ;
	let velmult = progress["tempo_multiplier"] ;
	let velText = "" ;
	if( !isNaN(velmult)){
		velText = "" + Math.round( velmult*10 )/10 + "x " ;
	}
	textById("velocityText", velText );
	let rpsec = progress["rpsec"] ;

	
	if( progress["tacho_installed"] ){
		let rt = Math.round( progress["rpsec"]*10)/10 ;
		document.getElementById("crankInfo").style.display = "" ;
		if( progress["is_turning"] ) {
			textById("turning", "Girando")
		}
		else {
			textById("turning", "No gira")
		}
		textById("rpsecText", "" + rt) ;

		let rg = Math.round( (rpsec-0.5)*(100/1.5) ) ;
		if ( rg < 0 ) {
			rg = 0 ;
		}
		else if( rg > 100 ) {
			rg = 100 ;
		}

		barGraph( "rpsecGraph", rg/100, sap_green, 10, "left", 50 ) ;
        
        f = document.getElementById("tempo_follows_crank");
        f.checked = progress["tempo_follows_crank"] ;
	}
	else {
		document.getElementById("crankInfo").style.display = "none" ;	
	}

	if( isUsedFromServer() ){
		// This page is residing on drehorgel.pythonanywhere.com
		// disable non-functional buttons (no action on this server)
		// No progress during tunes, since mcserver is disabled during tune
		// No 1/2 column select, may be too confusing
		// Always show lyrics
		document.getElementById("crank_span").style.display = "none";
		document.getElementById("lyrics_span").style.display = "";
		document.getElementById("setlist_span").style.display = "none";
		document.getElementById("toggleSetlistLyricsButton").style.display = "none" ;
		document.getElementById("col1_link").style.display = "none" ;
		document.getElementById("col2_link").style.display = "none" ;
		document.getElementById("timebar").style.display = "none";
		document.getElementById("progress").style.display = "none";
		
		d = document.getElementById("controlButtons");
		if( d != null && d != undefined ){
			d.style.display = "none" ;
		}

	}
}


async function saveSetList() {
	let resp = await fetch_json("/save_setlist" ) ;
	if( resp["result"] == "ok" ) {
		showPopup( "saved", tlt("Guardado")) ;
	}	
	else {
		showPopup( "saved", tlt("No guardado, error")) ;
	}
}

async function shuffleAllTunes() {
	await updateProgress( await fetch_json("/shuffle_all_tunes" ) ) ;
}

async function shuffleSetList() {
	await updateProgress( await fetch_json("/shuffle_set_list" ) ) ;
}

async function loadSetList() {
	await updateProgress( await fetch_json("/load_setlist" ) ) ;
}

async function clearSetList() {
	await updateProgress( await fetch_json("/clear_setlist" ) ) ;
}

async function upSetList(pos) {
	await updateProgress( await fetch_json("/up_setlist/" + pos ) ) ;
}

async function downSetList(pos) {
	await updateProgress( await fetch_json("/down_setlist/" + pos ) ) ;
}

async function dropSetList(pos) {
	await updateProgress( await fetch_json("/drop_setlist/" + pos ) ) ;
}

async function topSetList(pos) {
	await updateProgress( await fetch_json("/top_setlist/" + pos ) ) ;
}

async function set_velocity( increment ) {
	await updateProgress( await fetch_json( "/set_velocity_relative/" + increment ) );
}

async function check_cancelled( progress ) {
    // Skip cancelled state, it distracts visually
    for( i = 0; i < 3; i++ ){
        progress = await fetch_json( "/get_progress" ) ;
        if( progress["status"] != "cancelled" ){
            break ;
        }
    }
    return progress ;
}
    
// For these functions skip cancelled state since
// it's temporary and distracting
async function startTune() {
    progress =  await fetch_json( "/start_tune" ) ;
    await updateProgress( progress );

}

async function stopTuneSetList() {
	progress = await fetch_json("/stop_tune_setlist" ) ;
    progress = await check_cancelled() ;
	await updateProgress( progress ) ;
}

async function backSetList() {
	progress = await fetch_json( "/back_setlist" ) ;
    progress = await check_cancelled() ;
	await updateProgress( progress ) ;
}
    
async function tempo_follows_crank(){
    f = document.getElementById("tempo_follows_crank");
    data = { "tempo_follows_crank": f.checked };
    await fetch_json( "/tempo_follows_crank", data );
}

function go_history(){
	window.location.href = "/static/history.html" ;
}

function toggleSetlistLyrics( what ){
	let setlist_span =  document.getElementById( "setlist_span") ;
	let lyrics_span =  document.getElementById( "lyrics_span") ;
	let toggle_button = document.getElementById( "toggleSetlistLyricsButton" ) ;
	if( setlist_span.style.display == "none" || what == "setlist" ){
		setlist_span.style.display = "";
		lyrics_span.style.display = "none" ;
		toggle_button.innerText = "Mostrar letra" ;
	}
	else{

		setlist_span.style.display = "none";
		lyrics_span.style.display = "" ;
		toggle_button.innerText = "Mostrar setlist" ;
	}
}

async function setColumns(c){
	columns = c ;
	await formatLyrics() ;
}
async function formatLyrics(){
	let col1 = document.getElementById( "col1") ;
	let col2 = document.getElementById( "col2") ;
	let lyrics = await get_lyrics( current_tuneid ) ;
	if( columns == 1){
		col1.innerText = lyrics ;
		col1.colSpan = 2 ;
		col2.innerText = "";
	}
	else{
		i = Math.round(lyrics.length/2) ;
		while( i < lyrics.length ){
			if( lyrics.substring(i,i+1) == "\n"){
				break ;
			}
			i = i + 1 ;
		}
		l1 = lyrics.substring(0,i+1);
		l2 = lyrics.substring(i);
		col1.innerText = l1 ;
		col1.colSpan = 1 ;
		col2.innerText = l2;

	}
}


translate_html();
getProgress() ;


</script>
