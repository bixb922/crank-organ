<!DOCTYPE html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" type="text/css" href="/static/skeleton.css">
	<style>
	  th {
		background-color: #D4AF37; 
		}
	</style>
</head>
<body>
<span id="popup" class="popuptext"></span>    
<div class="headerdiv">
	<span class="headerleft">
        <a onclick="pageUp()">&#11013;</a>
    </span>
	<span class="headerright" id="header_time"></span>
</div>

<script type="text/javascript" src="/static/common.js"></script>
<button type="button" onclick="tuneAll()" id="tuneAllButton">Afinar todos</button>

<button type="button" onclick="scaleTest()" id="scaleTestButton">Escala de prueba</button>

<table id="notelist" style="width:100%">
</table>
<div class="footerdiv"></div>

</body>

<script>
async function getNoteList() {
	while( true ) {
		updateNoteList( await fetch_json("/data/organtuner.json" ) );
		await sleep_ms( 5_000 ) ;
	}
}

function updateNoteList( notelist ) {
	const header = ["Programa-nota", "cents", "dB", 
		"Afinaci&oacute;n (-"+max_cents+" a +"+max_cents+" cents)", 
		"Amplitud (" + min_db + " a " + max_db + " dB)",
        "Pin"] ;
	let s = "<thead><tr>" ;
	for (var i = 0; i < header.length; i++) {
		s += `<th>${header[i]}</th>`;
	}
	s += "</tr></thead>" ;
	s += "<tbody>" ;
    // notelist is a dictionary, key=midi note number
    
	for( midi in notelist ){
		var note = notelist[midi]  ;
		s += `
		    <tr>
			 <td><a href="/note/${midi}">${note["name"]}</td>
			 <td>${Math.round(note["cents"])}</td>
			 <td>${amplitude_to_db( note["amp"] )}</td>
			 <td id="tuning${midi}"></td>
			 <td id="amp${midi}"></td>
			 <td id="pin${midi}">${note["pinname"]}</td>
			</tr>`;
	};
	s += "</tbody>" ;
	htmlById("notelist", s) ;

	for( midi in notelist ){
		var note = notelist[midi] ;
		lrBarGraph( "tuning" + midi, scale_cents( note["cents"] ), oxford_blue, scale_divisions_cents, 20 ) ;
		
		var db = amplitude_to_db( note["amp"] ) ;
		barGraph( "amp" + midi, scale_db( db ), sap_green, scale_divisions_db, "right", 20 );
	}	
}

async function tuneAll() {
	textoOriginal = document.getElementById("tuneAllButton").innerText ;
	textById("tuneAllButton", "\u231B") ;
	updateNoteList( await fetch_json( "/tune_all" )  );
	textById("tuneAllButton", textoOriginal ) ;

}

async function scaleTest() {
    await fetch_json( "/scale_test" ) ;   
}
    
function pageUp() {
	// Go back to index page
	window.location.href = "/static/index.html" ;
}

getNoteList() ;

</script>