<!DOCTYPE html>

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<link rel="stylesheet" type="text/css" href="/static/skeleton.css">
</head>

<body>
<span id="popup" class="popuptext"></span>
<div class="headerdiv">
	<span class="headerleft">
        <a onclick="pageUp()">&#11013;</a>
		&nbsp;Verlauf
    </span>
	<span class="headerright" id="header_time"></span>
</div>

<!-- html continues below javascript -->
<script type="text/javascript" src="/static/common.js"></script>
<div class="tableFixHead">

    <table>
        <thead>
          <tr>
            <th>Datum</th>
            <th>Melodie</th>
            <th>% abgespielt</th>
            <th>Wunsch&nbsp;</th>
          </tr>
        </thead>
        <tbody id="history">
        </tbody>
    </table>
</div>
<div class="middlediv"></div>
	Wenn älter als
	<input type="text" size="3" value="90" id="days"/>Tage,
	<button onclick="deleteHistory()" id="purgeButton">Löschen </button>
<div class="footerdiv"></div>
</body>

<script>

function compare( a, b ){
    // compare to sort in descending date order
    // dates are in yyyy-mm-dd hh:mm format
    datea = a[1];
    dateb = b[1];
    if( datea < dateb ){
        return 1 ;
    }
    if( datea > dateb ){
        return -1;
    }
    return 0;
}


async function getHistory( ) {
	
	let histlist = await fetch_json( "/get_history" ) ;
    histlist.sort( compareFn=compare ) ;
	let s = "" ;
    previous_date = "";
	for( i in histlist ) {
        let hist_element = histlist[i]; 
        // 0 title
        // 1 date and time
        // 2 percentage
        // 3 requested by user
        // 4 tuneid
        tsplit = hist_element[1].split(" ");
        date = tsplit[0] ;
        time = tsplit[1] ;
        // Make row with date when date changes
        if( date != previous_date) {
            s += `<tr>
            <td colspan="3"><b>${date}</b></td>
            <tr>` ;
        };
        previous_date = date ;
        let user_request = "" ;
        if( hist_element[3] ) {
            // user request
            user_request = "&#x2714;" ; // check mark
        }
        let tt = make_tune_title(  hist_element[4], hist_element[0]);
		s += `<tr> 
			   <td>${time}</td>
			   <td>${tt}</td>
		       <td align="right">${hist_element[2]}%</td>
			   <td>${user_request}</td>
		      </tr>`;
	}
	htmlById("history", s) ;
}

async function deleteHistory(){
	days = parseInt( document.getElementById("days").value );
	resp = await fetch_json( "/delete_history/" + days ) ;
    if( resp["result"] == "ok"){
	   window.location.href = "/static/history.html" ;
    }
}


getHistory() ;
</script>